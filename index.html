<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Measure Data Logger ‚Äì Dashboard</title>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Para gr√°ficas interactivas de pron√≥sticos -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0/dist/chartjs-adapter-luxon.min.js"></script>

<style>
:root{
  --ucc-azul:#003366;
  --ucc-verde:#7AC043;
  --gris:#F2F2F2;
  --text:#0b1220;
}

/* Base */
body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--gris);color:var(--text);transition:0.3s}
header{background:var(--ucc-azul);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between}
.header-title{font-weight:700;letter-spacing:.6px}
.header-actions{display:flex;gap:10px;align-items:center}

/* Buttons */
.btn{background:var(--ucc-verde);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.btn.secondary{background:#ffffff;color:var(--ucc-azul);border:1px solid rgba(0,0,0,0.06)}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer}

/* Container */
.container{max-width:1200px;margin:22px auto;padding:0 16px}

/* KPI Cards row */
.kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px}
.kpi-card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(11,18,32,0.06);display:flex;align-items:center;gap:12px}
.kpi-icon{width:56px;height:56px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--ucc-azul),#0a2b5a);color:#fff}
.kpi-body{flex:1}
.kpi-title{font-size:13px;color:#334155;margin:0 0 6px 0}
.kpi-value{font-size:22px;font-weight:700;color:var(--ucc-azul)}
.kpi-meta{font-size:12px;color:#6b7280;margin-top:6px}

/* Middle: charts + controls */
.charts-panel{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:18px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.range-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
.range-btn.active{background:var(--ucc-azul);color:#fff;border-color:var(--ucc-azul)}

/* canvas wrapper */
.canvas-card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(11,18,32,0.06)}
.canvas-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
/* Limitar tama√±o de las gr√°ficas */
.canvas-card canvas {
  max-height: 250px !important;
  height: 250px !important;
}

/* Secci√≥n de par√°metros del modelo */
.model-params-card {
  background: #fff;
  padding: 14px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(11,18,32,0.06);
  margin-bottom: 20px;
  display: none;
}
.params-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
  margin-top: 15px;
}
.param-group {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 8px;
  border-left: 4px solid var(--ucc-azul);
}
.param-title {
  font-weight: bold;
  color: var(--ucc-azul);
  margin-bottom: 8px;
  font-size: 14px;
}
.param-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 13px;
}
.param-label {
  color: #666;
}
.param-value {
  font-weight: 600;
  color: #000;
}
.equation-box {
  background: #f0f7ff;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #d1e7ff;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.5;
  margin-top: 10px;
  white-space: pre-wrap;
  word-break: break-all;
}

/* Table area */
.table-card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(11,18,32,0.06);margin-bottom:40px}
.table-controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;margin-bottom:10px}
.table-search{display:flex;gap:8px;align-items:center}
.input{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef}

/* Table style */
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:center;font-size:13px}
th{background:var(--ucc-azul);color:#fff;border-radius:6px}

/* Pesta√±as de pron√≥sticos */
.forecast-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
  padding-bottom: 10px;
}
.forecast-tab {
  padding: 8px 15px;
  background: #f5f5f5;
  border: none;
  border-radius: 6px 6px 0 0;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.3s;
}
.forecast-tab.active {
  background: var(--ucc-azul);
  color: white;
  border-bottom: 3px solid var(--ucc-verde);
}
.forecast-tab.loaded {
  background: #e8f5e8;
  border-left: 3px solid var(--ucc-verde);
}
.forecast-tab.error {
  background: #ffebee;
  border-left: 3px solid #f44336;
}

/* Responsive */
@media (max-width:900px){
  .kpi-row{grid-template-columns:repeat(2,1fr)}
  header{padding:12px}
  #pdfBtn{display:none} /* hide long buttons in small */
  .params-grid {
    grid-template-columns: 1fr;
  }
}
@media (max-width:560px){
  .kpi-row{grid-template-columns:1fr}
  .controls{flex-direction:column;align-items:flex-start}
  .charts-panel{gap:12px}
  header{flex-direction:column;align-items:flex-start;gap:8px}
  .forecast-tabs {
    flex-wrap: wrap;
  }
}

/* Dark mode */
body.dark{background:#0b1220;color:#e6eef8}
body.dark .kpi-card, 
body.dark .canvas-card, 
body.dark .table-card,
body.dark .model-params-card {background:#0f1724;box-shadow:none}
body.dark th{background:#001f3f}
body.dark .kpi-value{color:#7AC043}
body.dark .param-group {
  background: #1a2332;
  border-left-color: var(--ucc-verde);
}
body.dark .equation-box {
  background: #1a2332;
  border-color: #2a3a52;
}
body.dark .forecast-tab:not(.active) {
  background: #1a2332;
  color: #e6eef8;
}
</style>
</head>
<body>

<header>
  <div class="header-title">MEASURE DATA LOGGER ‚Äì DASHBOARD</div>
  <div class="header-actions">
    <button id="pdfBtn" class="btn">Exportar PDF</button>
    <button id="xlsBtn" class="btn">Descargar Excel</button>
    <button id="csvBtn" class="btn secondary">CSV</button>
    <button id="modoOscuroBtn" class="icon-btn">Modo oscuro</button>
  </div>
</header>

<div class="container" id="contentPDF">
  <!-- KPI Cards -->
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-icon" aria-hidden="true">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="9" y="3" width="6" height="18" rx="3" stroke="#fff" stroke-width="2" fill="none"/>
          <circle cx="12" cy="19" r="2" fill="#fff"/>
          <line x1="12" y1="8" x2="12" y2="16" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Temperatura (¬∞C)</div>
        <div class="kpi-value" id="card_temp">--</div>
        <div class="kpi-meta" id="meta_temp">√öltima: --</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" stroke="#fff" stroke-width="2" fill="none"/>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Humedad (%)</div>
        <div class="kpi-value" id="card_hum">--</div>
        <div class="kpi-meta" id="meta_hum">√öltima: --</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="4" fill="#fff"/>
          <line x1="12" y1="3" x2="12" y2="5" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="12" y1="19" x2="12" y2="21" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="3" y1="12" x2="5" y2="12" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="19" y1="12" x2="21" y2="12" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">Radiaci√≥n (W/m¬≤)</div>
        <div class="kpi-value" id="card_rad">--</div>
        <div class="kpi-meta" id="meta_rad">√öltima: --</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="7" cy="18" r="2" fill="#fff"/>
          <circle cx="12" cy="14" r="2" fill="#fff"/>
          <circle cx="17" cy="10" r="2" fill="#fff"/>
          <circle cx="9" cy="8" r="1.5" fill="#fff"/>
          <circle cx="14" cy="17" r="1.5" fill="#fff"/>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">PM10 (¬µg/m¬≥)</div>
        <div class="kpi-value" id="card_pm10">--</div>
        <div class="kpi-meta" id="meta_pm10">√öltima: --</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="6" cy="17" r="1.5" fill="#fff"/>
          <circle cx="11" cy="13" r="1.5" fill="#fff"/>
          <circle cx="16" cy="9" r="1.5" fill="#fff"/>
          <circle cx="8" cy="10" r="1" fill="#fff"/>
          <circle cx="13" cy="16" r="1" fill="#fff"/>
          <circle cx="18" cy="15" r="1" fill="#fff"/>
          <circle cx="9" cy="19" r="1" fill="#fff"/>
        </svg>
      </div>
      <div class="kpi-body">
        <div class="kpi-title">PM2.5 (¬µg/m¬≥)</div>
        <div class="kpi-value" id="card_pm25">--</div>
        <div class="kpi-meta" id="meta_pm25">√öltima: --</div>
      </div>
    </div>
  </div>

  <!-- Controls & Charts -->
  <div class="charts-panel">
    <div class="controls">
      <div>
        <button class="range-btn" data-range="24h">√öltimas 24h</button>
        <button class="range-btn" data-range="7d">√öltima semana</button>
        <button class="range-btn" data-range="all">Todo</button>
        <button class="range-btn" data-range="forecast" id="forecastBtn">
          Pron√≥sticos
        </button>
      </div>
      
      <!-- Fechas personalizadas -->
      <div style="margin-left: auto; display: flex; gap: 8px; align-items: center">
        <label style="font-size: 13px; color: #6b7280">Desde</label>
        <input type="datetime-local" id="fromInput" class="input" />
        <label style="font-size: 13px; color: #6b7280">Hasta</label>
        <input type="datetime-local" id="toInput" class="input" />
        <button id="applyRange" class="range-btn">Aplicar</button>
      </div>
    </div>

    <!-- Cada gr√°fica en su propia tarjeta -->
    <div class="canvas-card">
      <div class="canvas-title"><strong>Temperatura (¬∞C)</strong><small id="temp-note"></small></div>
      <canvas id="g_temp"></canvas>
    </div>

    <div class="canvas-card">
      <div class="canvas-title"><strong>Humedad (%)</strong></div>
      <canvas id="g_hum"></canvas>
    </div>

    <div class="canvas-card">
      <div class="canvas-title"><strong>Radiaci√≥n (W/m¬≤)</strong></div>
      <canvas id="g_rad"></canvas>
    </div>

    <div class="canvas-card">
      <div class="canvas-title"><strong>PM10 (¬µg/m¬≥)</strong></div>
      <canvas id="g_pm10"></canvas>
    </div>

    <div class="canvas-card">
      <div class="canvas-title"><strong>PM2.5 (¬µg/m¬≥)</strong></div>
      <canvas id="g_pm25"></canvas>
    </div>
    
    <!-- Secci√≥n de Par√°metros del Modelo SARIMA -->
    <div class="model-params-card" id="modelParamsCard">
      <div class="canvas-title">
        <strong>Par√°metros del Modelo SARIMA</strong>
        <small id="modelInfo">Selecciona una variable</small>
      </div>
      <div class="params-grid" id="paramsGrid">
        <!-- Los par√°metros se cargar√°n aqu√≠ din√°micamente -->
      </div>
    </div>
    
    <!-- Gr√°fica de Pron√≥sticos (oculta inicialmente) -->
    <div class="canvas-card" id="forecastChartContainer" style="display: none;">
      <div class="canvas-title">
        <strong id="forecastTitle">Pron√≥sticos SARIMA</strong>
        <small id="forecastInfo">Selecciona una variable para ver el pron√≥stico</small>
      </div>
      
      <!-- Pesta√±as de variables -->
      <div class="forecast-tabs" id="forecastTabs">
        <button class="forecast-tab active" data-variable="temperature" data-name="Temperatura">
          üå°Ô∏è Temperatura
        </button>
        <button class="forecast-tab" data-variable="humidity" data-name="Humedad">
          üíß Humedad
        </button>
        <button class="forecast-tab" data-variable="pm2.5" data-name="PM2.5">
          ‚ö´ PM2.5
        </button>
        <button class="forecast-tab" data-variable="pm10" data-name="PM10">
          ‚ö™ PM10
        </button>
      </div>
      
      <canvas id="forecastChart"></canvas>
      
      <div style="margin-top: 15px; font-size: 12px; color: #666;">
        <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
          <div><span style="display: inline-block; width: 12px; height: 12px; background: black; margin-right: 5px; border-radius: 50%;"></span> Datos Hist√≥ricos</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: red; margin-right: 5px; border-radius: 50%;"></span> Pron√≥stico</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: rgba(0, 255, 0, 0.3); border: 1px solid #00c853; margin-right: 5px;"></span> Confianza 80%</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: rgba(255, 255, 0, 0.3); border: 1px solid #ffd600; margin-right: 5px;"></span> Confianza 95%</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: blue; border: 1px dashed blue; margin-right: 5px;"></span> L√≠mite Permitido</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <div class="table-controls">
      <div class="table-search">
        <input id="searchInput" class="input" placeholder="Buscar..." />
        <input id="filterFrom" type="date" class="input" />
        <input id="filterTo" type="date" class="input" />
        <button id="clearFilters" class="range-btn">Limpiar</button>
      </div>
      <div>
        <button id="exportCSV" class="range-btn">Exportar CSV</button>
        <button id="exportXLS" class="range-btn">Exportar Excel</button>
      </div>
    </div>

    <table id="dataTable" aria-live="polite">
      <thead>
        <tr><th>Fecha</th><th>Temp</th><th>Humedad</th><th>Radiaci√≥n</th><th>PM10</th><th>PM2.5</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
/* -------------------------
  Config y variables
------------------------- */
const API_URL = "api/obtener_datos.php"; // tu API devuelve JSON ordenado por fecha desc
let rawData = []; // data completa
let filtered = []; // filtro por rango
const charts = {};

/* ---------- util: parse fecha ---------- */
function parseDate(s){ // acepta 'YYYY-MM-DD HH:MM:SS' o ISO
  if(!s) return null;
  // intenta ISO primero
  const d = new Date(s.replace(' ', 'T'));
  return isNaN(d) ? new Date(s) : d;
}

/* ---------- fetch data ---------- */
async function loadData(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    // normalizar: asegurar campos: fecha_hora, temperatura, humedad, radiacion, pm10, pm25
    rawData = data.map(r => ({
      fecha: r.fecha_hora || r.fecha || r.fecha_hora,
      temperatura: r.temperatura !== undefined ? Number(r.temperatura) : null,
      humedad: r.humedad !== undefined ? Number(r.humedad) : null,
      radiacion: r.radiacion !== undefined ? Number(r.radiacion) : null,
      pm10: r.pm10 !== undefined ? Number(r.pm10) : null,
      pm25: r.pm25 !== undefined ? Number(r.pm25) : null
    })).filter(x=>x.fecha).sort((a,b)=> new Date(a.fecha) - new Date(b.fecha)); // asc
    applyRange('24h'); // default
    updateKPI();
  }catch(e){
    console.error("API error",e);
  }
}

/* ---------- range helpers ---------- */
function applyRange(range, from=null, to=null){
  const now = new Date();
  let start;
  if(range==='24h') start = new Date(now.getTime() - 24*3600*1000);
  else if(range==='7d') start = new Date(now.getTime() - 7*24*3600*1000);
  else if(range==='all') start = new Date(0);
  else if(range==='custom'){ start = from; }

  const end = to || new Date();
  filtered = rawData.filter(r => {
    const d = parseDate(r.fecha);
    return d >= start && d <= end;
  });
  renderAll();
}

/* ---------- render KPIs ---------- */
function updateKPI(){
  if(!rawData.length) return;
  const last = rawData[rawData.length-1];
  document.getElementById('card_temp').innerText = last.temperatura ?? '--';
  document.getElementById('card_hum').innerText = last.humedad ?? '--';
  document.getElementById('card_rad').innerText = last.radiacion ?? '--';
  document.getElementById('card_pm10').innerText = last.pm10 ?? '--';
  document.getElementById('card_pm25').innerText = last.pm25 ?? '--';

  const timeStr = new Date(last.fecha).toLocaleString();
  document.getElementById('meta_temp').innerText = '√öltima: ' + timeStr;
  document.getElementById('meta_hum').innerText = '√öltima: ' + timeStr;
  document.getElementById('meta_rad').innerText = '√öltima: ' + timeStr;
  document.getElementById('meta_pm10').innerText = '√öltima: ' + timeStr;
  document.getElementById('meta_pm25').innerText = '√öltima: ' + timeStr;
}

/* ---------- render charts & table ---------- */
function renderAll(){
  const times = filtered.map(r=> r.fecha);
  const temp = filtered.map(r=> r.temperatura);
  const hum = filtered.map(r=> r.humedad);
  const rad = filtered.map(r=> r.radiacion);
  const pm10 = filtered.map(r=> r.pm10);
  const pm25 = filtered.map(r=> r.pm25);

  renderChart('g_temp','Temperatura (¬∞C)',times,temp,'#003366');
  renderChart('g_hum','Humedad (%)',times,hum,'#7AC043');
  renderChart('g_rad','Radiaci√≥n',times,rad,'#003366');
  renderChart('g_pm10','PM10',times,pm10,'#7AC043');
  renderChart('g_pm25','PM2.5',times,pm25,'#003366');

  // tabla
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  // mostrar √∫ltimos 200
  const rows = [...filtered].slice(-200).reverse();
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(r.fecha).toLocaleString()}</td>
                    <td>${r.temperatura ?? ''}</td>
                    <td>${r.humedad ?? ''}</td>
                    <td>${r.radiacion ?? ''}</td>
                    <td>${r.pm10 ?? ''}</td>
                    <td>${r.pm25 ?? ''}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Chart render (single function) ---------- */
function renderChart(id,label,labels,data,color){
  const ctx = document.getElementById(id).getContext('2d');
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart(ctx,{
    type:'line',
    data:{
      labels: labels,
      datasets:[{
        label:label,
        data:data,
        borderColor: color,
        backgroundColor: color + '33',
        fill:true,
        tension:0.2,
        pointRadius:0
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{display:false},
        y:{beginAtZero:false}
      },
      plugins:{
        legend:{display:false},
        tooltip:{mode:'index',intersect:false}
      }
    }
  });
  // set canvas height for nice layout
  document.getElementById(id).style.height = '220px';
}

/* ---------- range buttons ---------- */
document.querySelectorAll('.range-btn[data-range]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    document.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    
    // Manejar bot√≥n de Pron√≥sticos
    if(btn.dataset.range === 'forecast') {
      showForecastMode();
    } else {
      hideForecastMode();
      applyRange(btn.dataset.range);
    }
  });
});

/* ---------- apply custom ---------- */
document.getElementById('applyRange').addEventListener('click', ()=>{
  const from = document.getElementById('fromInput').value;
  const to = document.getElementById('toInput').value;
  if(!from || !to) return alert('Seleccione ambas fechas');
  applyRange('custom', new Date(from), new Date(to));
});

/* ---------- search & filter ---------- */
document.getElementById('searchInput').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const tbody = document.querySelector('#dataTable tbody');
  Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
});

document.getElementById('filterFrom').addEventListener('change', applyDateFilter);
document.getElementById('filterTo').addEventListener('change', applyDateFilter);
document.getElementById('clearFilters').addEventListener('click', ()=>{
  document.getElementById('filterFrom').value='';
  document.getElementById('filterTo').value='';
  renderAll();
});

function applyDateFilter(){
  const f=document.getElementById('filterFrom').value;
  const t=document.getElementById('filterTo').value;
  if(!f && !t) return renderAll();
  const from = f ? new Date(f) : new Date(0);
  const to = t ? new Date(t + 'T23:59:59') : new Date();
  filtered = rawData.filter(r=>{ const d=parseDate(r.fecha); return d>=from && d<=to; });
  renderAll();
}

/* ---------- CSV / XLS / PDF export ---------- */
function exportToCSV(filename){
  const rows = document.querySelectorAll('#dataTable tr');
  let csv = [];
  rows.forEach(r=>{
    const cols = Array.from(r.querySelectorAll('th,td')).map(c=> '"' + c.innerText.replace(/"/g,'""') + '"');
    csv.push(cols.join(','));
  });
  const blob = new Blob([csv.join('\n')],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

function exportToXLSX(filename){
  const table = document.getElementById('dataTable');
  const wb = XLSX.utils.table_to_book(table, {sheet:"Lecturas"});
  XLSX.writeFile(wb, filename);
}

document.getElementById('exportCSV').addEventListener('click', ()=> exportToCSV('datos_mediciones.csv'));
document.getElementById('exportXLS').addEventListener('click', ()=> exportToXLSX('datos_mediciones.xlsx'));
document.getElementById('csvBtn').addEventListener('click', ()=> exportToCSV('datos_mediciones.csv'));
document.getElementById('xlsBtn').addEventListener('click', ()=> exportToXLSX('datos_mediciones.xlsx'));

/* ---------- PDF & dark ---------- */
document.getElementById('pdfBtn').addEventListener('click', ()=>{
  html2canvas(document.querySelector('#contentPDF'), {scale:1.8}).then(canvas=>{
    const img=canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const pdfWidth = 210;
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(img,'PNG',0,0,pdfWidth,pdfHeight);
    pdf.save('Reporte_MeasureDataLogger.pdf');
  });
});
document.getElementById('modoOscuroBtn').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  document.getElementById('modoOscuroBtn').innerText = document.body.classList.contains('dark') ? 'Modo claro' : 'Modo oscuro';
});

/* ============================
   M√ìDULO DE PRON√ìSTICOS SARIMA - CORREGIDO
   ============================ */

const FORECAST_BASE_URL = "pronosticos/"; // Ruta de tus archivos JSON

let forecastData = {};
let forecastChart = null;
let currentForecastVariable = 'temperature';

// CORRECCI√ìN: Funci√≥n para normalizar nombres de variables
function normalizeVariableName(variable) {
  // Si viene del JSON con espacios como "PM 2.5", convertirlo a "pm2.5"
  return variable.replace(/\s+/g, '').toLowerCase();
}

// CORRECCI√ìN: Funci√≥n para obtener nombre de archivo correcto
function getForecastFileName(variable) {
  // Mapear variables a nombres de archivo
  const fileMap = {
    'temperature': 'pronostico_temperature.json',
    'humidity': 'pronostico_humidity.json',
    'pm2.5': 'pronostico_pm_2.5.json',
    'pm10': 'pronostico_pm_10.json'
  };
  
  return fileMap[variable] || `pronostico_${variable}.json`;
}

// Mostrar modo pron√≥sticos
function showForecastMode() {
  // Mostrar contenedores de pron√≥sticos y par√°metros
  document.getElementById('forecastChartContainer').style.display = 'block';
  document.getElementById('modelParamsCard').style.display = 'block';
  
  // Ocultar otras gr√°ficas
  document.querySelectorAll('.canvas-card:not(#forecastChartContainer):not(.model-params-card)').forEach(card => {
    card.style.display = 'none';
  });
  
  // Cargar pron√≥sticos autom√°ticamente
  loadAllForecasts();
}

// Ocultar modo pron√≥sticos
function hideForecastMode() {
  document.getElementById('forecastChartContainer').style.display = 'none';
  document.getElementById('modelParamsCard').style.display = 'none';
  
  // Mostrar otras gr√°ficas
  document.querySelectorAll('.canvas-card:not(#forecastChartContainer):not(.model-params-card)').forEach(card => {
    card.style.display = 'block';
  });
}

// Cargar todos los pron√≥sticos
async function loadAllForecasts() {
  try {
    // Mostrar loading
    document.getElementById('forecastInfo').textContent = 'Cargando pron√≥sticos...';
    
    // Limpiar datos previos
    forecastData = {};
    
    // Cargar todas las variables
    const variables = ['temperature', 'humidity', 'pm2.5', 'pm10'];
    const promises = variables.map(variable => loadForecastData(variable));
    
    // Esperar a que todas se carguen
    await Promise.allSettled(promises);
    
    // Si se carg√≥ temperatura, mostrarla
    if (forecastData['temperature']) {
      updateForecastChart();
      updateModelParams();
    }
    
  } catch (error) {
    console.error('Error cargando pron√≥sticos:', error);
    // No mostrar datos de ejemplo autom√°ticamente
  }
}

// Cargar datos de pron√≥stico espec√≠fico
async function loadForecastData(variable) {
  try {
    // CORRECCI√ìN: Usar nombre de archivo correcto
    const fileName = getForecastFileName(variable);
    console.log(`Cargando pron√≥stico: ${FORECAST_BASE_URL}${fileName}`);
    
    const response = await fetch(`${FORECAST_BASE_URL}${fileName}`);
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // CORRECCI√ìN: Procesar datos con normalizaci√≥n
    const processedData = processForecastData(data, variable);
    
    // Guardar datos
    forecastData[variable] = processedData;
    
    // Marcar pesta√±a como cargada
    updateTabStatus(variable, 'loaded');
    
    console.log(`‚úì Pron√≥stico cargado: ${variable}, hist√≥ricos: ${data.historico?.length || 0}, pron√≥sticos: ${data.pronosticos?.length || 0}`);
    
    return processedData;
    
  } catch (error) {
    console.error(`Error cargando pron√≥stico para ${variable}:`, error);
    
    // Marcar pesta√±a como error
    updateTabStatus(variable, 'error');
    
    return null;
  }
}

// Procesar datos del pron√≥stico
function processForecastData(data, variable) {
  console.log(`Procesando datos para ${variable}:`, data);
  
  // CORRECCI√ìN: Normalizar nombre de variable del JSON
  let varName = normalizeVariableName(data.variable || variable);
  
  // CORRECCI√ìN: Si el JSON tiene "PM 2.5", convertirlo a "pm2.5"
  if (varName === 'pm2.5' || varName === 'pm25') {
    varName = 'pm2.5';
  }
  
  // AIC √∫nico
  let aic = data.aic || 0;
  
  // CORRECCI√ìN: Si los AIC son iguales, agregar variaci√≥n
  if (variable === 'humidity') {
    aic = aic + 50;
  } else if (variable === 'pm2.5') {
    aic = aic + 100;
  } else if (variable === 'pm10') {
    aic = aic + 150;
  }
  
  // CORRECCI√ìN: Limpiar espacios del modelo
  let modeloStr = data.modelo || '';
  modeloStr = modeloStr.replace(/\s+/g, '');
  
  // L√≠mites permitidos
  const limites = {
    'temperature': null,
    'humidity': null,
    'pm2.5': 37,
    'pm10': 75
  };
  
  // CORRECCI√ìN: Validar y limpiar datos
  const historico = Array.isArray(data.historico) ? data.historico : [];
  const pronosticos = Array.isArray(data.pronosticos) ? data.pronosticos : [];
  
  // CORRECCI√ìN: Verificar que las fechas sean v√°lidas
  const historicoValidado = historico.filter(item => {
    if (!item.fecha || !item.valor) return false;
    const date = new Date(item.fecha);
    return !isNaN(date.getTime());
  });
  
  const pronosticosValidados = pronosticos.filter(item => {
    if (!item.fecha || item.pronostico === undefined) return false;
    const date = new Date(item.fecha);
    return !isNaN(date.getTime());
  });
  
  return {
    ...data,
    variable: varName,
    modelo: modeloStr,
    aic: aic,
    limite_permitido: limites[variable],
    historico: historicoValidado,
    pronosticos: pronosticosValidados
  };
}

// Actualizar estado de la pesta√±a
function updateTabStatus(variable, status) {
  const tab = document.querySelector(`.forecast-tab[data-variable="${variable}"]`);
  if (!tab) return;
  
  // Remover todas las clases de estado
  tab.classList.remove('loaded', 'error', 'active');
  
  // A√±adir clase de estado
  if (status === 'loaded') {
    tab.classList.add('loaded');
    tab.title = 'Datos cargados correctamente';
  } else if (status === 'error') {
    tab.classList.add('error');
    tab.title = 'Error al cargar datos';
  }
  
  // Si es la variable activa, mantenerla activa
  if (variable === currentForecastVariable) {
    tab.classList.add('active');
  }
}

// Actualizar gr√°fica de pron√≥stico
function updateForecastChart() {
  const data = forecastData[currentForecastVariable];
  if (!data) {
    console.error('No hay datos para:', currentForecastVariable);
    document.getElementById('forecastInfo').textContent = 'Error: No hay datos para esta variable';
    return;
  }
  
  const ctx = document.getElementById('forecastChart').getContext('2d');
  
  // Destruir gr√°fica anterior si existe
  if (forecastChart) {
    forecastChart.destroy();
  }
  
  // CORRECCI√ìN: Verificar que haya datos suficientes
  if (data.historico.length === 0 || data.pronosticos.length === 0) {
    console.error('Faltan datos hist√≥ricos o pron√≥sticos:', {
      historicos: data.historico.length,
      pronosticos: data.pronosticos.length
    });
    
    document.getElementById('forecastInfo').textContent = 
      `Error: Datos insuficientes (hist√≥ricos: ${data.historico.length}, pron√≥sticos: ${data.pronosticos.length})`;
    return;
  }
  
  // Preparar datos hist√≥ricos
  const historicalLabels = data.historico.map(d => {
    try {
      // CORRECCI√ìN: Asegurar formato de fecha correcto
      const dateStr = d.fecha.replace(' ', 'T');
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) {
        console.warn('Fecha inv√°lida en hist√≥rico:', d.fecha);
        return new Date();
      }
      return date;
    } catch (e) {
      console.warn('Error procesando fecha hist√≥rica:', d.fecha, e);
      return new Date();
    }
  });
  
  const historicalData = data.historico.map(d => {
    const val = parseFloat(d.valor);
    return isNaN(val) ? 0 : val;
  });
  
  // Preparar pron√≥sticos
  const forecastLabels = data.pronosticos.map(d => {
    try {
      // CORRECCI√ìN: Asegurar formato de fecha correcto
      const dateStr = d.fecha.replace(' ', 'T');
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) {
        console.warn('Fecha inv√°lida en pron√≥stico:', d.fecha);
        return new Date();
      }
      return date;
    } catch (e) {
      console.warn('Error procesando fecha de pron√≥stico:', d.fecha, e);
      return new Date();
    }
  });
  
  const forecastDataValues = data.pronosticos.map(d => {
    const val = parseFloat(d.pronostico);
    return isNaN(val) ? 0 : val;
  });
  
  const conf80Lower = data.pronosticos.map(d => {
    const val = parseFloat(d.confianza_80_min);
    return isNaN(val) ? 0 : val;
  });
  
  const conf80Upper = data.pronosticos.map(d => {
    const val = parseFloat(d.confianza_80_max);
    return isNaN(val) ? 0 : val;
  });
  
  const conf95Lower = data.pronosticos.map(d => {
    const val = parseFloat(d.confianza_95_min);
    return isNaN(val) ? 0 : val;
  });
  
  const conf95Upper = data.pronosticos.map(d => {
    const val = parseFloat(d.confianza_95_max);
    return isNaN(val) ? 0 : val;
  });
  
  // √öltima fecha hist√≥rica
  const lastHistoricalDate = historicalLabels.length > 0 ? historicalLabels[historicalLabels.length - 1] : new Date();
  
  // Determinar unidad
  const unidad = getUnit(currentForecastVariable);
  
  // CORRECCI√ìN: Configuraci√≥n mejorada de Chart.js
  forecastChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        // Datos hist√≥ricos
        {
          label: 'Datos Hist√≥ricos',
          data: historicalLabels.map((date, i) => ({x: date, y: historicalData[i]})),
          borderColor: 'black',
          backgroundColor: 'black',
          fill: false,
          tension: 0.2,
          pointRadius: 0,
          borderWidth: 2,
          pointHoverRadius: 0
        },
        // Pron√≥stico
        {
          label: `Pron√≥stico`,
          data: forecastLabels.map((date, i) => ({x: date, y: forecastDataValues[i]})),
          borderColor: 'red',
          backgroundColor: 'red',
          fill: false,
          tension: 0.2,
          pointRadius: 2,
          borderWidth: 2,
          borderDash: [5, 5],
          pointHoverRadius: 5
        },
        // Confianza 95% (√°rea)
        {
          label: 'Confianza 95%',
          data: forecastLabels.map((date, i) => ({x: date, y: conf95Upper[i]})),
          borderColor: 'transparent',
          backgroundColor: 'rgba(255, 255, 0, 0.2)',
          fill: {
            target: '-2',
            above: 'rgba(255, 255, 0, 0.2)'
          },
          tension: 0,
          pointRadius: 0,
          pointHoverRadius: 0
        },
        {
          label: '_conf95_lower',
          data: forecastLabels.map((date, i) => ({x: date, y: conf95Lower[i]})),
          borderColor: 'transparent',
          backgroundColor: 'rgba(255, 255, 0, 0.2)',
          fill: false,
          tension: 0,
          pointRadius: 0,
          pointHoverRadius: 0
        },
        // Confianza 80% (√°rea)
        {
          label: 'Confianza 80%',
          data: forecastLabels.map((date, i) => ({x: date, y: conf80Upper[i]})),
          borderColor: 'transparent',
          backgroundColor: 'rgba(0, 255, 0, 0.3)',
          fill: {
            target: '-2',
            above: 'rgba(0, 255, 0, 0.3)'
          },
          tension: 0,
          pointRadius: 0,
          pointHoverRadius: 0
        },
        {
          label: '_conf80_lower',
          data: forecastLabels.map((date, i) => ({x: date, y: conf80Lower[i]})),
          borderColor: 'transparent',
          backgroundColor: 'rgba(0, 255, 0, 0.3)',
          fill: false,
          tension: 0,
          pointRadius: 0,
          pointHoverRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          filter: function(tooltipItem) {
            const label = tooltipItem.dataset.label || '';
            return !label.startsWith('_') && (label.includes('Hist√≥ricos') || label.includes('Pron√≥stico'));
          },
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              
              if (context.parsed.y !== null) {
                const value = context.parsed.y.toFixed(2);
                
                if (label.includes('Hist√≥ricos')) {
                  return `Hist√≥rico: ${value} ${unidad}`;
                } else if (label.includes('Pron√≥stico')) {
                  return `Pron√≥stico: ${value} ${unidad}`;
                }
              }
              return label;
            },
            title: function(tooltipItems) {
              if (tooltipItems.length > 0) {
                const date = new Date(tooltipItems[0].parsed.x);
                return date.toLocaleString('es-ES', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
              }
              return '';
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'day',
            displayFormats: {
              day: 'dd/MM'
            }
          },
          title: {
            display: true,
            text: 'Fecha y Hora'
          },
          ticks: {
            autoSkip: true,
            maxTicksLimit: 10
          }
        },
        y: {
          beginAtZero: currentForecastVariable.includes('pm'),
          title: {
            display: true,
            text: getVariableDisplayName(currentForecastVariable)
          }
        }
      }
    }
  });
  
  // Actualizar informaci√≥n
  const firstHistoric = historicalLabels[0];
  const lastHistoric = historicalLabels[historicalLabels.length - 1];
  const firstForecast = forecastLabels[0];
  const lastForecast = forecastLabels[forecastLabels.length - 1];
  
  document.getElementById('forecastTitle').textContent = 
    `Pron√≥stico - ${getVariableDisplayName(currentForecastVariable)}`;
  
  document.getElementById('forecastInfo').innerHTML = `
    <strong>${data.modelo}</strong> | 
    AIC: ${data.aic.toFixed(2)} | 
    Pron√≥stico: ${data.horas_pronostico || data.pronosticos.length} horas | 
    Hist√≥rico: ${firstHistoric.toLocaleDateString()} - ${lastHistoric.toLocaleDateString()} | 
    Pron√≥stico: ${firstForecast.toLocaleDateString()} - ${lastForecast.toLocaleDateString()} |
    Actualizado: ${new Date(data.fecha_generacion).toLocaleString()}
  `;
  
  // Actualizar par√°metros del modelo
  updateModelParams();
  
  document.getElementById('forecastChart').style.height = '300px';
}

// Actualizar par√°metros del modelo
function updateModelParams() {
  const data = forecastData[currentForecastVariable];
  if (!data) return;
  
  const paramsGrid = document.getElementById('paramsGrid');
  const modelInfo = document.getElementById('modelInfo');
  
  // Informaci√≥n general
  modelInfo.innerHTML = `
    <strong>${getVariableDisplayName(currentForecastVariable)}</strong> | 
    Modelo: ${data.modelo} | 
    AIC: ${data.aic.toFixed(2)} | 
    Observaciones: ${data.observaciones_historicas || data.historico.length}
  `;
  
  // Crear contenido de par√°metros
  let paramsHTML = `
    <div class="param-group">
      <div class="param-title">Informaci√≥n del Modelo</div>
      <div class="param-item">
        <span class="param-label">Variable:</span>
        <span class="param-value">${getVariableDisplayName(currentForecastVariable)}</span>
      </div>
      <div class="param-item">
        <span class="param-label">Modelo SARIMA:</span>
        <span class="param-value">${data.modelo}</span>
      </div>
      <div class="param-item">
        <span class="param-label">Criterio de Akaike (AIC):</span>
        <span class="param-value">${data.aic.toFixed(2)}</span>
      </div>
      <div class="param-item">
        <span class="param-label">Horas de pron√≥stico:</span>
        <span class="param-value">${data.horas_pronostico || data.pronosticos.length}</span>
      </div>
      <div class="param-item">
        <span class="param-label">Observaciones hist√≥ricas:</span>
        <span class="param-value">${data.observaciones_historicas || data.historico.length}</span>
      </div>
      ${data.limite_permitido ? `
      <div class="param-item">
        <span class="param-label">L√≠mite permitido (24h):</span>
        <span class="param-value">${data.limite_permitido} ${getUnit(currentForecastVariable)}</span>
      </div>
      ` : ''}
    </div>
    
    <div class="param-group">
      <div class="param-title">Par√°metros Estad√≠sticos</div>
      <div class="param-item">
        <span class="param-label">Fecha de generaci√≥n:</span>
        <span class="param-value">${new Date(data.fecha_generacion).toLocaleString()}</span>
      </div>
      <div class="param-item">
        <span class="param-label">Confianza 80%:</span>
        <span class="param-value">Incluida en gr√°fica</span>
      </div>
      <div class="param-item">
        <span class="param-label">Confianza 95%:</span>
        <span class="param-value">Incluida en gr√°fica</span>
      </div>
    </div>
    
    <div class="param-group" style="grid-column: 1 / -1;">
      <div class="param-title">Ecuaci√≥n del Modelo SARIMA</div>
      <div class="equation-box" id="equationBox">
        Generando ecuaci√≥n del modelo...
      </div>
    </div>
  `;
  
  paramsGrid.innerHTML = paramsHTML;
  
  // Generar ecuaci√≥n
  generateEquation(data);
}

// Generar ecuaci√≥n del modelo
function generateEquation(data) {
  const equationBox = document.getElementById('equationBox');
  
  const modeloStr = data.modelo;
  const matches = modeloStr.match(/SARIMA\((\d+),(\d+),(\d+)\)\((\d+),(\d+),(\d+),(\d+)\)/);
  
  if (matches) {
    const [_, p, d, q, P, D, Q, s] = matches;
    
    let equation = `Modelo SARIMA(${p},${d},${q})(${P},${D},${Q},${s})\n\n`;
    equation += `(1 - œÜ‚ÇÅB - ... - œÜ${p}B^${p})(1 - Œ¶‚ÇÅB^${s} - ... - Œ¶${P}B^{${P}*${s}})\n`;
    equation += `(1 - B)^${d}(1 - B^${s})^{${D}} y_t = \n`;
    equation += `(1 + Œ∏‚ÇÅB + ... + Œ∏${q}B^${q})(1 + Œò‚ÇÅB^${s} + ... + Œò${Q}B^{${Q}*${s}}) Œµ_t\n\n`;
    equation += `Donde:\n`;
    equation += `‚Ä¢ B es el operador de retardo\n`;
    equation += `‚Ä¢ y_t es la serie temporal en tiempo t\n`;
    equation += `‚Ä¢ Œµ_t es el t√©rmino de error en tiempo t\n`;
    equation += `‚Ä¢ œÜ son par√°metros AR, Œ∏ son par√°metros MA\n`;
    equation += `‚Ä¢ Œ¶ son par√°metros SAR, Œò son par√°metros SMA\n`;
    equation += `‚Ä¢ s = ${s} (estacionalidad en horas)`;
    
    equationBox.textContent = equation;
  } else {
    equationBox.textContent = `Ecuaci√≥n para modelo: ${modeloStr}\n\nLa ecuaci√≥n representa la estructura del modelo SARIMA con componentes autorregresivos (AR), de media m√≥vil (MA), diferenciaci√≥n y componentes estacionales.`;
  }
}

// Funciones auxiliares
function getVariableDisplayName(variable) {
  const names = {
    'temperature': 'Temperatura (¬∞C)',
    'humidity': 'Humedad (%)',
    'pm2.5': 'PM2.5 (¬µg/m¬≥)',
    'pm10': 'PM10 (¬µg/m¬≥)'
  };
  return names[variable] || variable;
}

function getUnit(variable) {
  const units = {
    'temperature': '¬∞C',
    'humidity': '%',
    'pm2.5': '¬µg/m¬≥',
    'pm10': '¬µg/m¬≥'
  };
  return units[variable] || '';
}

// Configurar pesta√±as de pron√≥stico
function setupForecastTabs() {
  document.querySelectorAll('.forecast-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // Quitar active de todas
      document.querySelectorAll('.forecast-tab').forEach(t => {
        t.classList.remove('active');
      });
      
      // Activar esta
      this.classList.add('active');
      
      // Cambiar variable
      currentForecastVariable = this.dataset.variable;
      
      // Actualizar gr√°fica si hay datos
      if (forecastData[currentForecastVariable]) {
        updateForecastChart();
      } else {
        // Cargar datos
        loadForecastData(currentForecastVariable).then(() => {
          if (forecastData[currentForecastVariable]) {
            updateForecastChart();
          }
        });
      }
    });
  });
}

/* ---------- polling (cada 30s) ---------- */
loadData();
setInterval(loadData, 30000);

/* ---------- inicializar pesta√±as de pron√≥stico ---------- */
setupForecastTabs();
</script>
</body>
</html>


