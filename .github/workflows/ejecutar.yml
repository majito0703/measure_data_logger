name: ğŸ¤– Ejecutar SARIMA AutomÃ¡tico

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ejecutar-sarima:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    # 1. ğŸ“¥ Descargar el cÃ³digo con FORCE para sobrescribir
    - name: Descargar cÃ³digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        # FORZAR checkout para evitar conflictos
        ref: ${{ github.ref }}
    
    # 2. ğŸ Instalar Python
    - name: Instalar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. ğŸ“¦ Instalar programas necesarios
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. ğŸš€ Ejecutar tu cÃ³digo (solo genera archivos)
    - name: Ejecutar modelo SARIMA
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GOOGLE_SHEETS_CREDS: ${{ secrets.GOOGLE_SHEETS_CREDS }}
      run: |
        echo "ğŸš€ Iniciando modelo SARIMA..."
        python modelo_sarima.py
    
    # 5. ğŸ” Verificar quÃ© archivos se generaron
    - name: Verificar archivos generados
      run: |
        echo "ğŸ“ Estructura de directorios despuÃ©s de ejecutar:"
        echo "=== RaÃ­z ==="
        ls -la
        echo ""
        echo "=== Carpeta pronosticos ==="
        ls -la pronosticos/
        echo ""
        echo "=== Contenido de archivos JSON (primeras lÃ­neas) ==="
        for file in pronosticos/*.json; do
          echo "ğŸ“„ $file:"
          head -5 "$file"
          echo ""
        done
    
    # 6. ğŸ“¤ Configurar git correctamente para el push
    - name: Configurar Git
      run: |
        echo "ğŸ”§ Configurando Git..."
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global pull.rebase false
    
    # 7. ğŸ”„ Sincronizar con los Ãºltimos cambios del repositorio
    - name: Sincronizar con repositorio remoto
      run: |
        echo "ğŸ”„ Sincronizando con cambios remotos..."
        # Obtener los Ãºltimos cambios
        git fetch origin
        # Hacer merge con estrategia "theirs" para aceptar cambios remotos
        git pull origin main --rebase || git pull origin main --allow-unrelated-histories || true
    
    # 8. ğŸ’¾ Agregar y commitear cambios
    - name: Agregar y committear cambios
      run: |
        echo "ğŸ’¾ Preparando cambios para commit..."
        
        # Agregar solo la carpeta pronosticos (evita conflictos)
        git add pronosticos/
        
        # Verificar si hay cambios
        if git status --porcelain | grep -q '^[ MADRC]'; then
          echo "ğŸ“‹ Cambios detectados:"
          git status --porcelain
          
          echo "ğŸ“ Creando commit..."
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica de pronÃ³sticos $(date +'%Y-%m-%d %H:%M')" || echo "âš ï¸ No se pudo crear commit (posiblemente sin cambios)"
        else
          echo "âš ï¸ No hay cambios para commit"
        fi
    
    # 9. ğŸš€ Hacer push de los cambios
    - name: Hacer push de cambios
      run: |
        echo "ğŸš€ Intentando hacer push..."
        
        # Primero, asegurar que tenemos la Ãºltima versiÃ³n
        echo "ğŸ”„ Actualizando desde remoto..."
        git pull origin main --rebase --autostash || true
        
        echo "ğŸ“¤ Haciendo push..."
        # Forzar push si es necesario (para workflow automÃ¡tico)
        git push origin HEAD:main || {
          echo "âš ï¸ Push fallÃ³, intentando con force..."
          git push origin HEAD:main --force-with-lease
        }
        
        echo "âœ… Push completado exitosamente"
