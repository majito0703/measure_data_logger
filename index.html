<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pron√≥stico Ambiental</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --primary-color: #7AC043;
            --secondary-color: #2196F3;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --success-color: #4CAF50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --card-radius: 12px;
        }

        .dark {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--card-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .value-display {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .value-unit {
            font-size: 20px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        .forecast-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .forecast-tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
        }

        .forecast-tab:hover {
            border-color: var(--primary-color);
        }

        .forecast-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .model-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.3s;
            z-index: 1000;
            border-left: 4px solid var(--primary-color);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .hourly-forecast {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 20px 0;
        }

        .hour-card {
            min-width: 100px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .hour-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .hour-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .hour-unit {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 15px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üå±</div>
                <h1>Pron√≥stico Ambiental</h1>
            </div>
            <div class="controls">
                <button class="btn" id="refreshBtn">
                    <span>üîÑ</span> Actualizar
                </button>
                <button class="btn" id="modoOscuroBtn">
                    <span>üåô</span> Modo oscuro
                </button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Calidad del Aire - PM2.5</div>
                    <div id="pm25Icon"></div>
                </div>
                <div class="value-display">
                    <span id="pm25Value">--</span>
                    <span class="value-unit" id="pm25Unit">¬µg/m¬≥</span>
                </div>
                <div class="chart-container">
                    <canvas id="pm25Chart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Calidad del Aire - PM10</div>
                    <div id="pm10Icon"></div>
                </div>
                <div class="value-display">
                    <span id="pm10Value">--</span>
                    <span class="value-unit" id="pm10Unit">¬µg/m¬≥</span>
                </div>
                <div class="chart-container">
                    <canvas id="pm10Chart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Temperatura</div>
                    <div id="tempIcon"></div>
                </div>
                <div class="value-display">
                    <span id="tempValue">--</span>
                    <span class="value-unit" id="tempUnit">¬∞C</span>
                </div>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Humedad</div>
                    <div id="humIcon"></div>
                </div>
                <div class="value-display">
                    <span id="humValue">--</span>
                    <span class="value-unit" id="humUnit">%</span>
                </div>
                <div class="chart-container">
                    <canvas id="humChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Pron√≥stico 24 Horas</div>
            </div>
            
            <div class="forecast-tabs">
                <div class="forecast-tab active" data-variable="pm2.5">PM2.5</div>
                <div class="forecast-tab" data-variable="pm10">PM10</div>
                <div class="forecast-tab" data-variable="temperature">Temperatura</div>
                <div class="forecast-tab" data-variable="humidity">Humedad</div>
            </div>

            <div class="model-info">
                <div class="info-item">
                    <div class="info-label">Modelo</div>
                    <div class="info-value" id="modelName">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Precisi√≥n</div>
                    <div class="info-value" id="modelAccuracy">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">√öltima actualizaci√≥n</div>
                    <div class="info-value" id="lastUpdate">--</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="forecastChart"></canvas>
            </div>

            <div id="hourlyForecastContainer">
                <h3 style="margin: 20px 0 10px 0;">Pron√≥stico Horario</h3>
                <div class="hourly-forecast" id="hourlyForecast">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notificationIcon">‚ÑπÔ∏è</span>
        <span id="notificationText">Mensaje de notificaci√≥n</span>
    </div>

<script>
/* ============================
   VARIABLES GLOBALES Y CONFIGURACI√ìN
   ============================ */
let currentData = {};
let forecastData = {};
let currentForecastVariable = 'pm2.5';
let forecastUpdateInterval;
let charts = {};

// Configuraci√≥n de colores para modo claro/oscuro
const chartColors = {
    light: {
        grid: '#e0e0e0',
        text: '#666666'
    },
    dark: {
        grid: '#404040',
        text: '#b0b0b0'
    }
};

/* ============================
   FUNCIONES DE UTILIDAD
   ============================ */
function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.getElementById('notification');
    const icon = document.getElementById('notificationIcon');
    const text = document.getElementById('notificationText');
    
    notification.className = 'notification';
    notification.classList.add(type);
    
    const icons = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå'
    };
    
    icon.textContent = icons[type] || '‚ÑπÔ∏è';
    text.textContent = message;
    
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, duration);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function normalizeVariableName(variable) {
    // Normaliza el nombre de variable para consistencia
    if (variable === 'pm25' || variable === 'pm2.5') {
        return 'pm2.5';
    }
    return variable;
}

/* ============================
   FUNCIONES DE GR√ÅFICOS
   ============================ */
function initializeChart(canvasId, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const isDark = document.body.classList.contains('dark');
    
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: label,
                data: [],
                borderColor: color,
                backgroundColor: color + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: color
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: isDark ? '#2d2d2d' : 'white',
                    titleColor: isDark ? '#ffffff' : '#1a1a1a',
                    bodyColor: isDark ? '#b0b0b0' : '#666666',
                    borderColor: isDark ? '#404040' : '#e0e0e0',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    grid: {
                        color: isDark ? chartColors.dark.grid : chartColors.light.grid
                    },
                    ticks: {
                        color: isDark ? chartColors.dark.text : chartColors.light.text
                    }
                },
                y: {
                    grid: {
                        color: isDark ? chartColors.dark.grid : chartColors.light.grid
                    },
                    ticks: {
                        color: isDark ? chartColors.dark.text : chartColors.light.text
                    },
                    beginAtZero: true
                }
            },
            animation: {
                duration: 750
            }
        }
    });
}

function updateChart(chart, newData, newLabels) {
    chart.data.labels = newLabels;
    chart.data.datasets[0].data = newData;
    chart.update('none');
}

/* ============================
   ICONOS DIN√ÅMICOS
   ============================ */
function getVariableIcon(variable, value) {
    let color = '#7AC043';
    let icon = '';
    
    const normalizedVar = normalizeVariableName(variable);
    
    switch(normalizedVar) {
        case 'temperature':
            if (value < 10) color = '#2196F3';
            else if (value < 25) color = '#4CAF50';
            else if (value < 35) color = '#FF9800';
            else color = '#F44336';
            
            icon = `
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22a5 5 0 0 0 5-5c0-2-2-3-2-3v-8a3 3 0 1 0-6 0v8s-2 1-2 3a5 5 0 0 0 5 5z" stroke="${color}" stroke-width="2" fill="${color}" fill-opacity="0.3"/>
                    <circle cx="12" cy="9" r="1" fill="${color}"/>
                </svg>
            `;
            break;
            
        case 'humidity':
            color = '#2196F3';
            icon = `
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" stroke="${color}" stroke-width="2" fill="${color}" fill-opacity="0.3"/>
                </svg>
            `;
            break;
            
        case 'pm2.5':
        case 'pm10':
            if (value < 50) color = '#4CAF50';
            else if (value < 100) color = '#FFEB3B';
            else if (value < 150) color = '#FF9800';
            else color = '#F44336';
            
            icon = `
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="7" cy="17" r="2" fill="${color}"/>
                    <circle cx="12" cy="13" r="2" fill="${color}"/>
                    <circle cx="17" cy="9" r="2" fill="${color}"/>
                    <circle cx="9" cy="9" r="1.5" fill="${color}" opacity="0.6"/>
                    <circle cx="14" cy="16" r="1.5" fill="${color}" opacity="0.6"/>
                </svg>
            `;
            break;
    }
    
    return icon;
}

function getUnit(variable) {
    const normalizedVar = normalizeVariableName(variable);
    const units = {
        'temperature': '¬∞C',
        'humidity': '%',
        'pm2.5': '¬µg/m¬≥',
        'pm10': '¬µg/m¬≥'
    };
    return units[normalizedVar] || '';
}

/* ============================
   CORREGIDO: FUNCI√ìN PARA OBTENER NOMBRE DE ARCHIVO
   ============================ */
function getForecastFileName(variable) {
    const normalizedVar = normalizeVariableName(variable);
    
    const fileMap = {
        'temperature': 'pronostico_temperature.json',
        'humidity': 'pronostico_humidity.json',
        'pm2.5': 'pronostico_pm2.5.json',
        'pm10': 'pronostico_pm10.json'
    };
    
    const fileName = fileMap[normalizedVar];
    console.log(`üìÑ Variable: "${variable}" ‚Üí Normalizada: "${normalizedVar}" ‚Üí Archivo: ${fileName}`);
    return fileName;
}

/* ============================
   CARGA DE DATOS
   ============================ */
async function loadData() {
    try {
        // Cargar datos actuales
        const [pm10Data, pm25Data, tempData, humData] = await Promise.all([
            fetch('datos_pm10.csv').then(r => r.text()),
            fetch('datos_pm2.5.csv').then(r => r.text()),
            fetch('index.json').then(r => r.json())
        ]);

        // Procesar datos PM10
        const pm10Rows = pm10Data.trim().split('\n');
        const pm10Values = pm10Rows.map(row => {
            const [date, value] = row.split(',');
            return parseFloat(value) || 0;
        }).filter(v => !isNaN(v));
        
        const pm10Dates = pm10Rows.map(row => row.split(',')[0]).filter(d => d);
        
        // Procesar datos PM2.5
        const pm25Rows = pm25Data.trim().split('\n');
        const pm25Values = pm25Rows.map(row => {
            const [date, value] = row.split(',');
            return parseFloat(value) || 0;
        }).filter(v => !isNaN(v));
        
        const pm25Dates = pm25Rows.map(row => row.split(',')[0]).filter(d => d);
        
        // Actualizar valores actuales
        const currentPM10 = pm10Values[pm10Values.length - 1] || 0;
        const currentPM25 = pm25Values[pm25Values.length - 1] || 0;
        const currentTemp = tempData.temperature?.current || 0;
        const currentHum = tempData.humidity?.current || 0;
        
        document.getElementById('pm10Value').textContent = currentPM10.toFixed(1);
        document.getElementById('pm25Value').textContent = currentPM25.toFixed(1);
        document.getElementById('tempValue').textContent = currentTemp.toFixed(1);
        document.getElementById('humValue').textContent = currentHum.toFixed(1);
        
        // Actualizar iconos
        document.getElementById('pm10Icon').innerHTML = getVariableIcon('pm10', currentPM10);
        document.getElementById('pm25Icon').innerHTML = getVariableIcon('pm2.5', currentPM25);
        document.getElementById('tempIcon').innerHTML = getVariableIcon('temperature', currentTemp);
        document.getElementById('humIcon').innerHTML = getVariableIcon('humidity', currentHum);
        
        // Inicializar o actualizar gr√°ficos
        if (!charts.pm10) {
            charts.pm10 = initializeChart('pm10Chart', 'PM10', '#FF9800');
        }
        if (!charts.pm25) {
            charts.pm25 = initializeChart('pm25Chart', 'PM2.5', '#9C27B0');
        }
        if (!charts.temp) {
            charts.temp = initializeChart('tempChart', 'Temperatura', '#F44336');
        }
        if (!charts.hum) {
            charts.hum = initializeChart('humChart', 'Humedad', '#2196F3');
        }
        
        // Actualizar gr√°ficos con √∫ltimos 24 puntos
        const last24 = (arr) => arr.slice(-24);
        
        updateChart(charts.pm10, last24(pm10Values), last24(pm10Dates));
        updateChart(charts.pm25, last24(pm25Values), last24(pm25Dates));
        
        // Para temperatura y humedad, usar datos del index.json
        if (tempData.temperature?.history) {
            const tempHistory = tempData.temperature.history.slice(-24);
            updateChart(charts.temp, tempHistory, Array.from({length: tempHistory.length}, (_, i) => `-${23-i}h`));
        }
        
        if (tempData.humidity?.history) {
            const humHistory = tempData.humidity.history.slice(-24);
            updateChart(charts.hum, humHistory, Array.from({length: humHistory.length}, (_, i) => `-${23-i}h`));
        }
        
        showNotification('Datos actualizados', 'success');
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        showNotification('Error cargando datos', 'error');
    }
}

/* ============================
   CARGA DE PRON√ìSTICOS
   ============================ */
async function loadForecastData(variable) {
    try {
        const normalizedVar = normalizeVariableName(variable);
        const fileName = getForecastFileName(normalizedVar);
        
        if (!fileName) {
            throw new Error(`No se encontr√≥ archivo para variable: ${variable}`);
        }
        
        console.log(`üìÇ Cargando pron√≥stico para ${normalizedVar} desde: ${fileName}`);
        
        const response = await fetch(`pronosticos/${fileName}`);
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Normalizar estructura de datos
        if (Array.isArray(data)) {
            // Si los datos ya son un array
            forecastData[normalizedVar] = {
                forecasts: data,
                metadata: {
                    model: 'LSTM',
                    accuracy: '0.92',
                    last_updated: new Date().toISOString()
                }
            };
        } else if (data.forecasts && Array.isArray(data.forecasts)) {
            // Si tienen estructura con metadata
            forecastData[normalizedVar] = data;
        } else {
            // Si es un objeto con otra estructura
            const forecasts = Object.values(data);
            forecastData[normalizedVar] = {
                forecasts: forecasts,
                metadata: {
                    model: 'LSTM',
                    accuracy: '0.92',
                    last_updated: new Date().toISOString()
                }
            };
        }
        
        console.log(`‚úÖ Pron√≥stico cargado para ${normalizedVar}:`, forecastData[normalizedVar].forecasts.length, 'puntos');
        return forecastData[normalizedVar];
        
    } catch (error) {
        console.error(`‚ùå Error cargando pron√≥stico para ${variable}:`, error);
        showNotification(`Error cargando pron√≥stico: ${variable}`, 'error');
        return null;
    }
}

async function loadAllForecasts() {
    const variables = ['pm2.5', 'pm10', 'temperature', 'humidity'];
    
    for (const variable of variables) {
        await loadForecastData(variable);
    }
    
    // Actualizar gr√°fico con variable actual
    if (forecastData[currentForecastVariable]) {
        updateForecastChart();
        updateModelParams();
        updateQuickStats();
    }
}

/* ============================
   GR√ÅFICO DE PRON√ìSTICO
   ============================ */
let forecastChart = null;

function initializeForecastChart() {
    const ctx = document.getElementById('forecastChart').getContext('2d');
    const isDark = document.body.classList.contains('dark');
    
    forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Pron√≥stico',
                data: [],
                borderColor: '#7AC043',
                backgroundColor: '#7AC04320',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#7AC043'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: isDark ? chartColors.dark.text : chartColors.light.text
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const unit = getUnit(currentForecastVariable);
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}${unit}`;
                        }
                    },
                    backgroundColor: isDark ? '#2d2d2d' : 'white',
                    titleColor: isDark ? '#ffffff' : '#1a1a1a',
                    bodyColor: isDark ? '#b0b0b0' : '#666666',
                    borderColor: isDark ? '#404040' : '#e0e0e0',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Horas futuras',
                        color: isDark ? chartColors.dark.text : chartColors.light.text
                    },
                    grid: {
                        color: isDark ? chartColors.dark.grid : chartColors.light.grid
                    },
                    ticks: {
                        color: isDark ? chartColors.dark.text : chartColors.light.text
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: () => {
                            const unit = getUnit(currentForecastVariable);
                            return `Valor (${unit})`;
                        },
                        color: isDark ? chartColors.dark.text : chartColors.light.text
                    },
                    grid: {
                        color: isDark ? chartColors.dark.grid : chartColors.light.grid
                    },
                    ticks: {
                        color: isDark ? chartColors.dark.text : chartColors.light.text,
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    },
                    beginAtZero: true
                }
            },
            animation: {
                duration: 1000
            }
        }
    });
}

function updateForecastChart() {
    const data = forecastData[currentForecastVariable];
    
    if (!data || !data.forecasts || !forecastChart) {
        console.warn(`No hay datos para ${currentForecastVariable} o gr√°fico no inicializado`);
        return;
    }
    
    const forecasts = data.forecasts;
    
    // Crear etiquetas de horas (ej: +1h, +2h, ...)
    const labels = forecasts.map((_, index) => `+${index + 1}h`);
    
    // Obtener valores, asegurando que sean n√∫meros
    const values = forecasts.map(item => {
        if (typeof item === 'number') return item;
        if (typeof item === 'object' && item.value !== undefined) return item.value;
        if (typeof item === 'object' && item.forecast !== undefined) return item.forecast;
        return 0;
    });
    
    // Actualizar datos del gr√°fico
    forecastChart.data.labels = labels;
    forecastChart.data.datasets[0].data = values;
    forecastChart.data.datasets[0].label = `Pron√≥stico ${currentForecastVariable.toUpperCase()}`;
    
    // Actualizar unidad en el eje Y
    forecastChart.options.scales.y.title.text = `Valor (${getUnit(currentForecastVariable)})`;
    
    forecastChart.update();
    
    // Actualizar pron√≥stico horario
    updateHourlyForecast(values, labels);
}

function updateHourlyForecast(values, labels) {
    const container = document.getElementById('hourlyForecast');
    const unit = getUnit(currentForecastVariable);
    
    container.innerHTML = '';
    
    // Mostrar solo las primeras 12 horas
    const displayCount = Math.min(12, values.length);
    
    for (let i = 0; i < displayCount; i++) {
        const hourCard = document.createElement('div');
        hourCard.className = 'hour-card';
        
        // Determinar color basado en el valor (especialmente para PM)
        let valueColor = '#4CAF50';
        const value = values[i];
        
        if (currentForecastVariable.includes('pm')) {
            if (value < 50) valueColor = '#4CAF50';
            else if (value < 100) valueColor = '#FFEB3B';
            else if (value < 150) valueColor = '#FF9800';
            else valueColor = '#F44336';
        } else if (currentForecastVariable === 'temperature') {
            if (value < 10) valueColor = '#2196F3';
            else if (value < 25) valueColor = '#4CAF50';
            else if (value < 35) valueColor = '#FF9800';
            else valueColor = '#F44336';
        } else if (currentForecastVariable === 'humidity') {
            valueColor = '#2196F3';
        }
        
        hourCard.innerHTML = `
            <div class="hour-time">${labels[i]}</div>
            <div class="hour-value" style="color: ${valueColor}">${value.toFixed(1)}</div>
            <div class="hour-unit">${unit}</div>
        `;
        
        container.appendChild(hourCard);
    }
}

function updateModelParams() {
    const data = forecastData[currentForecastVariable];
    
    if (!data || !data.metadata) {
        document.getElementById('modelName').textContent = '--';
        document.getElementById('modelAccuracy').textContent = '--';
        document.getElementById('lastUpdate').textContent = '--';
        return;
    }
    
    document.getElementById('modelName').textContent = data.metadata.model || 'LSTM';
    document.getElementById('modelAccuracy').textContent = data.metadata.accuracy ? 
        `${(parseFloat(data.metadata.accuracy) * 100).toFixed(1)}%` : '--';
    document.getElementById('lastUpdate').textContent = data.metadata.last_updated ? 
        formatDate(data.metadata.last_updated) : '--';
}

function updateQuickStats() {
    const data = forecastData[currentForecastVariable];
    
    if (!data || !data.forecasts) return;
    
    const values = data.forecasts.map(item => {
        if (typeof item === 'number') return item;
        if (typeof item === 'object' && item.value !== undefined) return item.value;
        if (typeof item === 'object' && item.forecast !== undefined) return item.forecast;
        return 0;
    });
    
    if (values.length === 0) return;
    
    const max = Math.max(...values);
    const min = Math.min(...values);
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    
    console.log(`üìä Stats para ${currentForecastVariable}: Max=${max.toFixed(1)}, Min=${min.toFixed(1)}, Avg=${avg.toFixed(1)}`);
}

/* ============================
   MODO PRON√ìSTICOS
   ============================ */
function showForecastMode() {
    document.getElementById('forecastChartContainer').style.display = 'block';
    document.getElementById('mainChartCard').style.display = 'none';
    document.getElementById('variableSelector').style.display = 'none';
    document.getElementById('hourlyForecastContainer').style.display = 'none';
    
    loadAllForecasts();
    
    if (forecastUpdateInterval) clearInterval(forecastUpdateInterval);
}

/* ============================
   EVENT LISTENERS
   ============================ */
document.getElementById('refreshBtn').addEventListener('click', () => {
    loadData();
    showNotification('Actualizando datos...', 'info');
});

document.getElementById('modoOscuroBtn').addEventListener('click', () => {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    document.getElementById('modoOscuroBtn').innerHTML = isDark ? 
        '<span>‚òÄÔ∏è</span> Modo claro' : 
        '<span>üåô</span> Modo oscuro';
    
    localStorage.setItem('darkMode', isDark);
    
    // Actualizar gr√°ficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) {
            chart.options.scales.x.grid.color = isDark ? chartColors.dark.grid : chartColors.light.grid;
            chart.options.scales.x.ticks.color = isDark ? chartColors.dark.text : chartColors.light.text;
            chart.options.scales.y.grid.color = isDark ? chartColors.dark.grid : chartColors.light.grid;
            chart.options.scales.y.ticks.color = isDark ? chartColors.dark.text : chartColors.light.text;
            chart.options.plugins.tooltip.backgroundColor = isDark ? '#2d2d2d' : 'white';
            chart.options.plugins.tooltip.titleColor = isDark ? '#ffffff' : '#1a1a1a';
            chart.options.plugins.tooltip.bodyColor = isDark ? '#b0b0b0' : '#666666';
            chart.options.plugins.tooltip.borderColor = isDark ? '#404040' : '#e0e0e0';
            chart.update();
        }
    });
    
    // Actualizar gr√°fico de pron√≥stico
    if (forecastChart) {
        forecastChart.options.scales.x.grid.color = isDark ? chartColors.dark.grid : chartColors.light.grid;
        forecastChart.options.scales.x.ticks.color = isDark ? chartColors.dark.text : chartColors.light.text;
        forecastChart.options.scales.x.title.color = isDark ? chartColors.dark.text : chartColors.light.text;
        forecastChart.options.scales.y.grid.color = isDark ? chartColors.dark.grid : chartColors.light.grid;
        forecastChart.options.scales.y.ticks.color = isDark ? chartColors.dark.text : chartColors.light.text;
        forecastChart.options.scales.y.title.color = isDark ? chartColors.dark.text : chartColors.light.text;
        forecastChart.options.plugins.legend.labels.color = isDark ? chartColors.dark.text : chartColors.light.text;
        forecastChart.options.plugins.tooltip.backgroundColor = isDark ? '#2d2d2d' : 'white';
        forecastChart.options.plugins.tooltip.titleColor = isDark ? '#ffffff' : '#1a1a1a';
        forecastChart.options.plugins.tooltip.bodyColor = isDark ? '#b0b0b0' : '#666666';
        forecastChart.options.plugins.tooltip.borderColor = isDark ? '#404040' : '#e0e0e0';
        forecastChart.update();
    }
    
    showNotification(`Modo ${isDark ? 'oscuro' : 'claro'} activado`, 'success');
});

if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
    document.getElementById('modoOscuroBtn').innerHTML = '<span>‚òÄÔ∏è</span> Modo claro';
}

document.querySelectorAll('.forecast-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.forecast-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        currentForecastVariable = normalizeVariableName(this.dataset.variable);
        
        if (forecastData[currentForecastVariable]) {
            updateForecastChart();
            updateModelParams();
            updateQuickStats();
        } else {
            loadForecastData(currentForecastVariable).then(() => {
                if (forecastData[currentForecastVariable]) {
                    updateForecastChart();
                    updateModelParams();
                    updateQuickStats();
                }
            });
        }
    });
});

/* ============================
   INICIALIZACI√ìN
   ============================ */
// Inicializar gr√°fico de pron√≥stico
initializeForecastChart();

// Cargar datos iniciales
loadData();
setInterval(loadData, 30000); // Actualizar cada 30 segundos

// Cargar pron√≥sticos iniciales
loadAllForecasts();

setTimeout(() => {
    showNotification('Dashboard cargado üéâ', 'success');
}, 1000);

console.log('%cüöÄ Dashboard Pro v2.0', 'color: #7AC043; font-size: 20px; font-weight: bold;');
console.log('%c‚úÖ Variables PM normalizadas: pm2.5 y pm10', 'color: #4CAF50; font-size: 14px;');
</script>
</body>
</html>
