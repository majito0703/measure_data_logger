name: Ejecutar Modelo SARIMA cada 12 horas

on:
  schedule:
    # Se ejecuta cada 12 horas (a las 00:00 y 12:00 UTC)
    # TambiÃ©n a las 06:00 y 18:00 para mÃ¡s cobertura
    - cron: '0 */6 * * *'  # Cada 6 horas
  # TambiÃ©n se puede ejecutar manualmente
  workflow_dispatch:

jobs:
  ejecutar-modelo:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Descargar cÃ³digo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        echo "Instalando dependencias bÃ¡sicas..."
        pip install --upgrade pip
        pip install gspread pandas numpy matplotlib statsmodels
        pip install jupyter nbconvert
        echo "âœ… Dependencias instaladas"
    
    - name: ğŸ”§ Convertir notebook a script (si es necesario)
      run: |
        # Verificar si existe el notebook
        if [ -f "modelo_sarima.ipynb" ]; then
          echo "Convirtiendo notebook a script Python..."
          jupyter nbconvert --to python modelo_sarima.ipynb
          echo "âœ… Notebook convertido"
        else
          echo "âœ… Usando archivo Python existente"
        fi
    
    - name: ğŸ”‘ Configurar Google Sheets access
      run: |
        echo "Configurando acceso a Google Sheets..."
        # Crear archivo de credenciales temporal
        echo "${{ secrets.GOOGLE_SHEETS_CREDS }}" > google_creds.json
        echo "âœ… Credenciales configuradas"
    
    - name: ğŸš€ Ejecutar Modelo SARIMA
      env:
        SHEET_URL: "${{ secrets.SHEET_URL }}"
        GITHUB_TOKEN: "${{ secrets.PERSONAL_TOKEN }}"
      run: |
        echo "ğŸ¯ Iniciando ejecuciÃ³n del modelo..."
        echo "URL de Sheets: $SHEET_URL"
        
        # Crear carpeta para pronÃ³sticos si no existe
        mkdir -p pronosticos
        
        # Ejecutar el script Python
        python -c "
import os
import json

# Configurar variables de entorno
os.environ['SHEET_URL'] = '${{ secrets.SHEET_URL }}'
os.environ['GITHUB_TOKEN'] = '${{ secrets.PERSONAL_TOKEN }}'

print('âœ… Variables configuradas')
print('ğŸ“Š Ejecutando modelo...')
"
        
        # Si tienes el archivo como script Python directo
        if [ -f "modelo_sarima.py" ]; then
          echo "ğŸ“„ Ejecutando modelo_sarima.py..."
          python modelo_sarima.py
        else
          echo "âŒ No se encontrÃ³ modelo_sarima.py"
          exit 1
        fi
    
    - name: ğŸ“¤ Subir resultados actualizados
      run: |
        echo "ğŸ“¤ Subiendo resultados a GitHub..."
        
        # Configurar git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Verificar quÃ© archivos se generaron
        echo "ğŸ“ Archivos generados:"
        ls -la
        
        if [ -d "pronosticos" ]; then
          echo "ğŸ“‚ Contenido de pronosticos/:"
          ls -la pronosticos/
        fi
        
        # Agregar cambios
        git add .
        
        # Verificar si hay cambios
        if git diff --cached --quiet; then
          echo "â„¹ï¸ No hay cambios para subir"
        else
          echo "ğŸ’¾ Guardando cambios..."
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica $(date '+%Y-%m-%d %H:%M')"
          git push origin main
          echo "âœ… Cambios subidos a GitHub"
        fi
    
    - name: ğŸ“Š Mostrar resultados
      if: always()
      run: |
        echo "ğŸ¯ RESUMEN DE EJECUCIÃ“N"
        echo "========================"
        date
        echo "Repositorio: https://github.com/${{ github.repository }}"
        echo "Carpeta pronÃ³sticos: https://github.com/${{ github.repository }}/tree/main/pronosticos"
        echo ""
        echo "ğŸ“ Archivos disponibles:"
        find . -name "*.json" -o -name "*.csv" | head -10
