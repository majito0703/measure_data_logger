name: ü§ñ Ejecutar SARIMA Autom√°tico

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ejecutar-sarima:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    # 0. üìÖ MOSTRAR INFORMACI√ìN DE PROGRAMACI√ìN (NUEVO PASO)
    - name: Mostrar informaci√≥n de ejecuci√≥n
      run: |
        echo "üìÖ INFORMACI√ìN DE EJECUCI√ìN PROGRAMADA"
        echo "========================================"
        echo ""
        echo "üîÑ Esta ejecuci√≥n fue activada por: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "‚úÖ EJECUCI√ìN AUTOM√ÅTICA (programada)"
        else
          echo "üë§ EJECUCI√ìN MANUAL (workflow_dispatch)"
        fi
        echo ""
        echo "‚è∞ FRECUENCIA PROGRAMADA:"
        echo "  ‚Ä¢ Cron: '0 */12 * * *'"
        echo "  ‚Ä¢ Se ejecuta cada 12 horas"
        echo "  ‚Ä¢ En punto de la hora (minuto 0)"
        echo "  ‚Ä¢ Hora base: UTC"
        echo ""
        echo "üåç PR√ìXIMAS EJECUCIONES CALCULADAS:"
        
        # Calcular pr√≥ximas ejecuciones
        python3 << 'EOF'
import datetime
import pytz
from datetime import timedelta

# Configurar zonas horarias
utc = pytz.UTC
bogota = pytz.timezone('America/Bogota')

print("\nHoras UTC (hora del servidor):")
print("-" * 40)

# Encontrar pr√≥ximas 4 ejecuciones UTC
ahora = datetime.datetime.now(utc)
print(f"Hora actual: {ahora.strftime('%Y-%m-%d %H:%M:%S UTC')}")

# Calcular cu√°ntas horas faltan para la pr√≥xima ejecuci√≥n (00:00 o 12:00 UTC)
horas_hasta_proxima = (12 - (ahora.hour % 12)) % 12
if horas_hasta_proxima == 0:
    horas_hasta_proxima = 12

print(f"\nPr√≥ximas 4 ejecuciones programadas:")

for i in range(4):
    # Calcular hora de ejecuci√≥n
    ejecucion_utc = (ahora.replace(minute=0, second=0, microsecond=0) + 
                     timedelta(hours=horas_hasta_proxima + i*12))
    
    # Convertir a Colombia
    ejecucion_colombia = ejecucion_utc.astimezone(bogota)
    
    # Calcular cu√°nto tiempo falta
    tiempo_falta = ejecucion_utc - ahora
    horas_faltan = int(tiempo_falta.total_seconds() // 3600)
    minutos_faltan = int((tiempo_falta.total_seconds() % 3600) // 60)
    
    print(f"\n{i+1}. {ejecucion_utc.strftime('%Y-%m-%d %H:%M UTC')}")
    print(f"   {ejecucion_colombia.strftime('%Y-%m-%d %H:%M %Z')}")
    print(f"   ‚è±Ô∏è  En {horas_faltan}h {minutos_faltan}m")

print(f"\nüìä RESUMEN PARA COLOMBIA:")
print(f"   ‚Ä¢ Ma√±ana 7:00 AM (si corresponde)")
print(f"   ‚Ä¢ Hoy 7:00 PM (si corresponde)")
print(f"   ‚Ä¢ Cada 12 horas (7AM / 7PM)")
EOF
        
        echo ""
        echo "üîó Para ver la pr√≥xima ejecuci√≥n oficial en GitHub:"
        echo "   1. Ve a la pesta√±a 'Actions'"
        echo "   2. Haz clic en 'ü§ñ Ejecutar SARIMA Autom√°tico'"
        echo "   3. Busca 'Next scheduled run:' en la parte superior"
    
    # 1. üì• Descargar el c√≥digo con FORCE para sobrescribir
    - name: Descargar c√≥digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        # FORZAR checkout para evitar conflictos
        ref: ${{ github.ref }}
    
    # 2. üêç Instalar Python
    - name: Instalar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. üì¶ Instalar programas necesarios
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. üöÄ Ejecutar tu c√≥digo (solo genera archivos)
    - name: Ejecutar modelo SARIMA
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GOOGLE_SHEETS_CREDS: ${{ secrets.GOOGLE_SHEETS_CREDS }}
      run: |
        echo "üöÄ Iniciando modelo SARIMA..."
        python modelo_sarima.py
    
    # 5. üîç Verificar qu√© archivos se generaron
    - name: Verificar archivos generados
      run: |
        echo "üìÅ Estructura de directorios despu√©s de ejecutar:"
        echo "=== Ra√≠z ==="
        ls -la
        echo ""
        echo "=== Carpeta pronosticos ==="
        ls -la pronosticos/
        echo ""
        echo "=== Contenido de archivos JSON (primeras l√≠neas) ==="
        for file in pronosticos/*.json; do
          echo "üìÑ $file:"
          head -5 "$file"
          echo ""
        done
    
    # 6. üì§ Configurar git correctamente para el push
    - name: Configurar Git
      run: |
        echo "üîß Configurando Git..."
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global pull.rebase false
    
    # 7. üîÑ Sincronizar con los √∫ltimos cambios del repositorio
    - name: Sincronizar con repositorio remoto
      run: |
        echo "üîÑ Sincronizando con cambios remotos..."
        # Obtener los √∫ltimos cambios
        git fetch origin
        # Hacer merge con estrategia "theirs" para aceptar cambios remotos
        git pull origin main --rebase || git pull origin main --allow-unrelated-histories || true
    
    # 8. üíæ Agregar y commitear cambios
    - name: Agregar y committear cambios
      run: |
        echo "üíæ Preparando cambios para commit..."
        
        # Agregar solo la carpeta pronosticos (evita conflictos)
        git add pronosticos/
        
        # Verificar si hay cambios
        if git status --porcelain | grep -q '^[ MADRC]'; then
          echo "üìã Cambios detectados:"
          git status --porcelain
          
          echo "üìù Creando commit..."
          git commit -m "ü§ñ Actualizaci√≥n autom√°tica de pron√≥sticos $(date +'%Y-%m-%d %H:%M')" || echo "‚ö†Ô∏è No se pudo crear commit (posiblemente sin cambios)"
        else
          echo "‚ö†Ô∏è No hay cambios para commit"
        fi
    
    # 9. üöÄ Hacer push de los cambios
    - name: Hacer push de cambios
      run: |
        echo "üöÄ Intentando hacer push..."
        
        # Primero, asegurar que tenemos la √∫ltima versi√≥n
        echo "üîÑ Actualizando desde remoto..."
        git pull origin main --rebase --autostash || true
        
        echo "üì§ Haciendo push..."
        # Forzar push si es necesario (para workflow autom√°tico)
        git push origin HEAD:main || {
          echo "‚ö†Ô∏è Push fall√≥, intentando con force..."
          git push origin HEAD:main --force-with-lease
        }
        
        echo "‚úÖ Push completado exitosamente"
        
    # 10. üìä MOSTRAR RESUMEN FINAL (NUEVO PASO)
    - name: Mostrar resumen final
      if: always()
      run: |
        echo ""
        echo "üìä RESUMEN DE EJECUCI√ìN"
        echo "========================"
        echo ""
        echo "‚úÖ Workflow completado: ${{ job.status }}"
        echo ""
        echo "üîÑ Pr√≥xima ejecuci√≥n autom√°tica:"
        echo "   ‚Ä¢ En aproximadamente 12 horas"
        
        # Calcular pr√≥xima ejecuci√≥n
        python3 << 'EOF'
import datetime
import pytz
from datetime import timedelta

utc = pytz.UTC
bogota = pytz.timezone('America/Bogota')

ahora = datetime.datetime.now(utc)
horas_hasta_proxima = (12 - (ahora.hour % 12)) % 12
if horas_hasta_proxima == 0:
    horas_hasta_proxima = 12

proxima_utc = ahora.replace(minute=0, second=0, microsecond=0) + timedelta(hours=horas_hasta_proxima)
proxima_colombia = proxima_utc.astimezone(bogota)

print(f"   ‚Ä¢ {proxima_utc.strftime('%Y-%m-%d %H:%M UTC')}")
print(f"   ‚Ä¢ {proxima_colombia.strftime('%Y-%m-%d %H:%M %Z')}")
EOF
        
        echo ""
        echo "üìÅ Tus datos est√°n disponibles en:"
        echo "   https://github.com/majito0703/measure_data_logger/tree/main/pronosticos"
        echo ""
        echo "üëÄ Para monitorear ejecuciones futuras:"
        echo "   https://github.com/majito0703/measure_data_logger/actions"
